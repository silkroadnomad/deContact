<script>
    import { onDestroy, onMount } from "svelte";
    import DeContactWorker from "../worker.js?worker"
    import "carbon-components-svelte/css/all.css";
    import ConnectionSignalOff from "carbon-icons-svelte/lib/ConnectionSignalOff.svelte";
    import ConnectionSignal from "carbon-icons-svelte/lib/ConnectionSignal.svelte";
    import WatsonHealthAiStatus from "carbon-icons-svelte/lib/WatsonHealthAiStatus.svelte";
    import WatsonHealthAiStatusComplete from "carbon-icons-svelte/lib/WatsonHealthAiStatusComplete.svelte";
    import { Header, HeaderGlobalAction, HeaderNav, HeaderUtilities, Theme } from "carbon-components-svelte";
    import { hash } from './router.js'
    import QRCodeModal from "$lib/components/QRCodeModal.svelte";
    import { myDal, qrCodeOpen, qrCodeData, seedPhrase, helia, orbitdb, masterSeed } from "../stores.js";

    import { startNetwork } from "../lib/network/p2p-operations.js"
    import { getIdentityAndCreateOrbitDB} from "$lib/network/getIdendityAndCreateOrbitDB.js"

    import { connectedPeers } from "../stores.js";
    import { confirmExperimentalUse } from "./confirmExperimentalUse.js";
    import { handleSeedphrase } from "./handleSeedphrase.js";
    import Home from './+page.svelte'
    import OnBoarding from "$lib/components/OnBoarding.svelte";

    let theme = "g90";

    $: if ($helia!==undefined && $masterSeed!==undefined && $seedPhrase!==undefined) {
        console.log("generating seed phrase")
        handleSeedphrase().then(() => {
            console.log("generated seed phrase - creating identity and starting orbitdb")
            getIdentityAndCreateOrbitDB('ed25519', $masterSeed, $helia)
                .then(dbInstance => {
                    orbitdb.set(dbInstance);
                })
                .catch(error => {
                    console.error('Failed to create OrbitDB instance:', error);
                });
        })
    }

    onMount(async ()=>{

        if (window.Worker) {
            const worker = new DeContactWorker();
            worker.postMessage("standby");
            // worker.postMessage([10, 2]); // Sending message as an array to our worker
            worker.onmessage = function(e) {
                console.log('Message received from worker: ' + e.data);
                try {
                    const msg = JSON.parse(e.data)
                    msg?.connectedPeers?$connectedPeers=msg?.connectedPeers:null

                }catch(e){
                    console.log("error while parsing webworker message")
                }

            }
        }
        else {
            if($hash!=='/onboarding'){
                await confirmExperimentalUse();
                await handleSeedphrase();
            }else
                await handleSeedphrase(true);

            await startNetwork();
        }

    })

    onDestroy(async ()=>{
        if (window.Worker) {
            const worker = new DeContactWorker();
            worker.postMessage("wakeup");
            // worker.postMessage([10, 2]); // Sending message as an array to our worker
            // worker.onmessage = function(e) {
            //     console.log('Message received from worker: ' + e.data);
            //     try {
            //         const msg = JSON.parse(e.data)
            //         msg?.connectedPeers?$connectedPeers=msg?.connectedPeers:null
            //
            //     }catch(e){
            //         console.log("error while parsing webworker message")
            //     }
            //
            // }
        }
    })

    let isSideNavOpen
    let title = "   - the cloud we are!"

    const routes = {
        '/': Home,
        '': Home,
        '/onboarding': OnBoarding
    }
    // $: console.log("$hash",$hash)
    $: view = routes[$hash]

        //    const urlParams = new URLSearchParams(window.location.search); //TODO url params we need when we "onboard" a new user via scanning a URL
</script>
<svelte:window on:beforeinstallprompt={ () => { console.log("beforeinstallprompt") }} />

    <Header
        class="header-title"
        persistentHamburgerMenu={true}
        bind:isSideNavOpen
        company="deContact.xyz"
        platformName={title}
        href="./#/">

        <HeaderNav>
            <div class="flags">
                 {#if ($connectedPeers===0) }
                     <ConnectionSignalOff title="No network or connecting..." class="statusRed" />&nbsp;{$connectedPeers}
                 {:else if $connectedPeers===1}
                     <ConnectionSignal title="Seed Node connected" class="statusYellow" />&nbsp;{$connectedPeers}
                 {:else}
                     <ConnectionSignal title="Swarm connected" class="statusGreen" />&nbsp;{$connectedPeers}
                 {/if}
            </div>
        </HeaderNav>

        <HeaderUtilities>
            <HeaderGlobalAction aria-label="dark-mode">
                <Theme
                        bind:theme
                        render="toggle"
                        toggle={{
                                themes: ["g90", "g80"],
                                labelA: "",
                                labelB: "",
                                hideLabel: true,
                                size: "sm",
                  }}/>
            </HeaderGlobalAction>
    </HeaderUtilities>
</Header>
<QRCodeModal
        on:close={ () => $qrCodeOpen = false }
        bind:qrCodeOpen={ $qrCodeOpen }
        qrCodeData={ $qrCodeData }
        dbMyDal={ $myDal } />
<!--<slot></slot>-->
<svelte:component this={ view } />
<style>
    :global(.bx--toast-notification) {
        z-index: 1;
        margin: 5rem;
    }
    :global(.statusRed) {
        color: red;
        width: 16px;
        height: 16px;
    }
    :global(.statusYellow) {
        color: yellow;
        width: 16px;
        height: 16px;
    }
    :global(.statusGreen) {
        color: green;
        width: 16px;
        height: 16px;
    }
    .flags {
        margin: 10px;
        display: flex;
        justify-content: space-between;
    }
</style>